<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý người dùng - React CRUD</title>
  
  <link rel="stylesheet" href="style.css">
  
  <!-- React, ReactDOM, Babel CDN -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // Component SearchForm - Nhận input từ người dùng để tìm kiếm
    // Logic: SearchForm nhận hàm onChangeValue (tức là setKeyword từ App)
    // Sử dụng sự kiện onChange để kích hoạt hàm callback, cập nhật kw ở App
    function SearchForm({ onChangeValue, value }) {
      return (
        <div className="search-container">
          <input
            type="text"
            className="search-input"
            placeholder="Tìm theo name, username"
            value={value}  // Controlled: giá trị được điều khiển bởi props
            onChange={(e) => onChangeValue(e.target.value)}  // Callback: truyền giá trị mới lên component cha
          />
        </div>
      );
    }

    // Component AddUser - Form thêm người dùng mới
    function AddUser({ onAdd }) {
      // State để quản lý việc hiển thị form (ẩn/hiện)
      const [adding, setAdding] = React.useState(false);
      
      // State để lưu trữ dữ liệu form
      // Sử dụng nested object cho address (state lồng nhau)
      const [user, setUser] = React.useState({
        name: "",
        username: "",
        email: "",
        address: {
          street: "",
          suite: "",
          city: ""
        },
        phone: "",
        website: ""
      });

      // Xử lý thay đổi input - dùng Spread Operator để cập nhật nested state (address)
      const handleChange = (e) => {
        const { id, value } = e.target;
        
        // Kiểm tra nếu field thuộc address (nested state)
        if (["street", "suite", "city"].includes(id)) {
          setUser({
            ...user,  // Sao chép toàn bộ user object
            address: {
              ...user.address,  // Sao chép toàn bộ address object
              [id]: value  // Cập nhật field cụ thể
            }
          });
        } else {
          // Field thuộc user trực tiếp
          setUser({
            ...user,  // Sao chép toàn bộ user object
            [id]: value  // Cập nhật field cụ thể
          });
        }
      };

      const handleAdd = () => {
        // Validation: Kiểm tra name và username có giá trị
        if (user.name === "" || user.username === "") {
          alert("Vui lòng nhập Name và Username!");
          return;
        }
        
        // Truyền dữ liệu lên component cha (App)
        onAdd(user);
        
        // Reset form về giá trị ban đầu
        setUser({
          name: "",
          username: "",
          email: "",
          address: {
            street: "",
            suite: "",
            city: ""
          },
          phone: "",
          website: ""
        });
        
        // Ẩn form
        setAdding(false);
      };

      return (
        <div className="form-container">
          <div className="form-header">
            <h3>Thêm người dùng</h3>
            {!adding && (
              <button className="btn-add" onClick={() => setAdding(true)}>
                Thêm
              </button>
            )}
          </div>
          
          {/* Hiển thị form khi adding = true */}
          {adding && (
            <div>
              <div className="form-grid">
                {/* Name field */}
                <div className="form-group">
                  <label htmlFor="name">Name: *</label>
                  <input
                    id="name"
                    type="text"
                    value={user.name}
                    onChange={handleChange}
                    placeholder="Nhập tên"
                  />
                </div>
                
                {/* Username field */}
                <div className="form-group">
                  <label htmlFor="username">Username: *</label>
                  <input
                    id="username"
                    type="text"
                    value={user.username}
                    onChange={handleChange}
                    placeholder="Nhập username"
                  />
                </div>
                
                {/* Email field */}
                <div className="form-group">
                  <label htmlFor="email">Email:</label>
                  <input
                    id="email"
                    type="email"
                    value={user.email}
                    onChange={handleChange}
                    placeholder="Nhập email"
                  />
                </div>
                
                {/* Phone field */}
                <div className="form-group">
                  <label htmlFor="phone">Phone:</label>
                  <input
                    id="phone"
                    type="text"
                    value={user.phone}
                    onChange={handleChange}
                    placeholder="Nhập số điện thoại"
                  />
                </div>
                
                {/* Address - Street */}
                <div className="form-group">
                  <label htmlFor="street">Street:</label>
                  <input
                    id="street"
                    type="text"
                    value={user.address.street}
                    onChange={handleChange}
                    placeholder="Nhập đường"
                  />
                </div>
                
                {/* Address - Suite */}
                <div className="form-group">
                  <label htmlFor="suite">Suite:</label>
                  <input
                    id="suite"
                    type="text"
                    value={user.address.suite}
                    onChange={handleChange}
                    placeholder="Nhập suite"
                  />
                </div>
                
                {/* Address - City */}
                <div className="form-group">
                  <label htmlFor="city">City:</label>
                  <input
                    id="city"
                    type="text"
                    value={user.address.city}
                    onChange={handleChange}
                    placeholder="Nhập thành phố"
                  />
                </div>
                
                {/* Website field */}
                <div className="form-group">
                  <label htmlFor="website">Website:</label>
                  <input
                    id="website"
                    type="text"
                    value={user.website}
                    onChange={handleChange}
                    placeholder="Nhập website"
                  />
                </div>
              </div>
              
              {/* Form actions */}
              <div className="form-actions">
                <button className="btn-submit" onClick={handleAdd}>
                  Thêm người dùng
                </button>
                <button className="btn-cancel" onClick={() => setAdding(false)}>
                  Hủy
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Component ResultTable - Hiển thị, lọc, sửa, xóa người dùng
    function ResultTable({ keyword, user, onAdded }) {
      // State: Lưu trữ danh sách users từ API
      // Khởi tạo với mảng rỗng []
      const [users, setUsers] = React.useState([]);
      
      // State: Quản lý trạng thái loading
      // Khởi tạo với true (đang tải) → sẽ set false sau khi fetch xong
      const [loading, setLoading] = React.useState(true);
      
      // State: Lưu trữ user đang được sửa
      // null = không có user nào đang được sửa
      const [editing, setEditing] = React.useState(null);

      // Tải dữ liệu 1 lần khi component mount
      React.useEffect(() => {
        fetch("https://jsonplaceholder.typicode.com/users")
          .then(res => res.json())  // Chuyển response thành JSON object
          .then(data => {
            setUsers(data);         // Lưu dữ liệu vào state users
            setLoading(false);      // Tắt loading indicator
          })
          .catch(error => {
            console.error("Error fetching users:", error);
            setLoading(false);      // Tắt loading ngay cả khi có lỗi
          });
      }, []); // [] = chỉ chạy 1 lần khi component mount

      React.useEffect(() => {
        if (user) {
          // Thêm user mới vào danh sách với ID mới
          setUsers((prev) => {
            // Tính ID mới: Lấy ID lớn nhất trong danh sách + 1
            // Nếu danh sách rỗng, ID = 1
            const maxId = prev.length > 0 
              ? Math.max(...prev.map(u => u.id)) 
              : 0;
            const newId = maxId + 1;
            
            return [
              ...prev,  // Sao chép toàn bộ users hiện tại
              { ...user, id: newId }  // Thêm user mới với ID mới
            ];
          });
          
          // Reset state newUser trong App về null
          onAdded();
        }
      }, [user]); // Chạy lại mỗi khi user thay đổi

      // Lọc danh sách theo keyword
      const filteredUsers = users.filter(
        (u) =>
          u.name.toLowerCase().includes(keyword.toLowerCase()) ||
          u.username.toLowerCase().includes(keyword.toLowerCase())
      );

      // Hàm mở form sửa - Deep Copy user vào editing state
      // Sao chép cả user và address để tránh thay đổi dữ liệu gốc
      const editUser = (user) => {
        setEditing({
          ...user,  // Sao chép toàn bộ user object
          address: { ...user.address }  // Deep copy address object
        });
      };

      // Xử lý thay đổi input trong form sửa
      const handleEditChange = (field, value) => {
        if (field === "street" || field === "suite" || field === "city") {
          // Field thuộc address (nested state)
          setEditing({
            ...editing,
            address: {
              ...editing.address,
              [field]: value
            }
          });
        } else {
          // Field thuộc user trực tiếp
          setEditing({
            ...editing,
            [field]: value
          });
        }
      };

      // Lưu thay đổi sau khi sửa
      const saveUser = () => {
        // Validation
        if (editing.name === "" || editing.username === "") {
          alert("Vui lòng nhập Name và Username!");
          return;
        }
        
        // Cập nhật user trong danh sách bằng Array.map()
        setUsers(prev => prev.map(u => 
          u.id === editing.id ? editing : u  // Thay thế user có id trùng với editing.id
        ));
        
        // Đóng form sửa
        setEditing(null);
      };

      // Hiển thị loading
      if (loading) {
        return (
          <div className="table-container">
            <h3>Danh sách người dùng</h3>
            <div className="loading">Đang tải dữ liệu...</div>
          </div>
        );
      }

      return (
        <div className="table-container">
          <h3>Danh sách người dùng ({filteredUsers.length})</h3>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Username</th>
                <th>Email</th>
                <th>City</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {/* 
                map(): Tạo danh sách các row từ mảng filteredUsers
                key={u.id}: Unique identifier cho mỗi element
                */}
              {filteredUsers.map((u) => (
                <tr key={u.id}>
                  <td>{u.id}</td>
                  <td>{u.name}</td>
                  <td>{u.username}</td>
                  <td>{u.email}</td>
                  <td>{u.address.city}</td>
                  <td>
                    <button 
                      className="btn-edit" 
                      onClick={() => editUser(u)}
                    >
                      Sửa
                    </button>
                    <button 
                      className="btn-delete" 
                      onClick={() => alert("Chức năng Xóa")}
                    >
                      Xóa
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {filteredUsers.length === 0 && keyword && (
            <p style={{ textAlign: "center", padding: "20px", color: "#666" }}>
              Không tìm thấy người dùng nào với từ khóa "{keyword}"
            </p>
          )}
          
          {/* Modal form sửa user */}
          {editing && (
            <div className="modal-overlay" onClick={() => setEditing(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <div className="modal-header">
                  <h4>Sửa người dùng</h4>
                  <button className="btn-close" onClick={() => setEditing(null)}>×</button>
                </div>
                
                <div className="form-grid">
                  {/* Name field */}
                  <div className="form-group">
                    <label htmlFor="edit-name">Name: *</label>
                    <input
                      id="edit-name"
                      type="text"
                      value={editing.name}
                      onChange={(e) => handleEditChange("name", e.target.value)}
                      placeholder="Nhập tên"
                    />
                  </div>
                  
                  {/* Username field */}
                  <div className="form-group">
                    <label htmlFor="edit-username">Username: *</label>
                    <input
                      id="edit-username"
                      type="text"
                      value={editing.username}
                      onChange={(e) => handleEditChange("username", e.target.value)}
                      placeholder="Nhập username"
                    />
                  </div>
                  
                  {/* Email field */}
                  <div className="form-group">
                    <label htmlFor="edit-email">Email:</label>
                    <input
                      id="edit-email"
                      type="email"
                      value={editing.email}
                      onChange={(e) => handleEditChange("email", e.target.value)}
                      placeholder="Nhập email"
                    />
                  </div>
                  
                  {/* Phone field */}
                  <div className="form-group">
                    <label htmlFor="edit-phone">Phone:</label>
                    <input
                      id="edit-phone"
                      type="text"
                      value={editing.phone}
                      onChange={(e) => handleEditChange("phone", e.target.value)}
                      placeholder="Nhập số điện thoại"
                    />
                  </div>
                  
                  {/* Address - Street */}
                  <div className="form-group">
                    <label htmlFor="edit-street">Street:</label>
                    <input
                      id="edit-street"
                      type="text"
                      value={editing.address.street}
                      onChange={(e) => handleEditChange("street", e.target.value)}
                      placeholder="Nhập đường"
                    />
                  </div>
                  
                  {/* Address - Suite */}
                  <div className="form-group">
                    <label htmlFor="edit-suite">Suite:</label>
                    <input
                      id="edit-suite"
                      type="text"
                      value={editing.address.suite}
                      onChange={(e) => handleEditChange("suite", e.target.value)}
                      placeholder="Nhập suite"
                    />
                  </div>
                  
                  {/* Address - City */}
                  <div className="form-group">
                    <label htmlFor="edit-city">City:</label>
                    <input
                      id="edit-city"
                      type="text"
                      value={editing.address.city}
                      onChange={(e) => handleEditChange("city", e.target.value)}
                      placeholder="Nhập thành phố"
                    />
                  </div>
                  
                  {/* Website field */}
                  <div className="form-group">
                    <label htmlFor="edit-website">Website:</label>
                    <input
                      id="edit-website"
                      type="text"
                      value={editing.website}
                      onChange={(e) => handleEditChange("website", e.target.value)}
                      placeholder="Nhập website"
                    />
                  </div>
                </div>
                
                {/* Form actions */}
                <div className="form-actions">
                  <button className="btn-submit" onClick={saveUser}>
                    Lưu thay đổi
                  </button>
                  <button className="btn-cancel" onClick={() => setEditing(null)}>
                    Hủy
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Component gốc App - Quản lý toàn bộ state và truyền props xuống con
    function App() {
      // State tập trung: keyword tìm kiếm
      const [kw, setKeyword] = React.useState("");
      
      // State tập trung: người dùng mới
      const [newUser, setNewUser] = React.useState(null);

      return (
        <div>
          <h1>Quản lý người dùng</h1>
          
          {/* SearchForm: Truyền hàm setKeyword và giá trị kw xuống component con */}
          {/* Khi người dùng nhập, App cập nhật kw, và ResultTable tự lọc lại danh sách qua keyword */}
          <SearchForm onChangeValue={setKeyword} value={kw} />
          
          {/* AddUser: Truyền hàm setNewUser xuống component con */}
          <AddUser onAdd={setNewUser} />
          
          {/* ResultTable: Truyền keyword, user mới, và hàm reset user xuống */}
          <ResultTable 
            keyword={kw} 
            user={newUser} 
            onAdded={() => setNewUser(null)} 
          />
        </div>
      );
    }

    // Render component App vào root
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

